
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <span class="material-symbols-rounded">smart_toy</span>
                </div>
                <span>AI Agent</span>
            </div>
            <div class="header-controls">
                <div id="test-mode-toggle" class="test-mode-toggle">
                    <label class="switch" title="Тестовый режим без API ключей">
                        <input type="checkbox" id="test-mode-checkbox">
                        <span class="slider round"></span>
                    </label>
                    <span class="test-mode-label">Тестовый режим</span>
                </div>
                <button id="clear-chat" class="icon-button" title="Очистить чат">
                    <span class="material-symbols-rounded">delete_sweep</span>
                </button>
                <button id="theme-toggle" class="icon-button" title="Переключить тему">
                    <span class="material-symbols-rounded">dark_mode</span>
                </button>
            </div>
        </header>
        
        <div class="sidebar-and-chat">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3>История чатов</h3>
                    <button id="new-chat" class="new-chat-button">
                        <span class="material-symbols-rounded">add</span>
                        Новый чат
                    </button>
                </div>
                <div class="chat-history" id="chat-history">
                    <!-- История чатов будет здесь -->
                    <div class="chat-history-loading">
                        <div class="spinner-small"></div>
                        <span>Загрузка истории...</span>
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <div id="chat-container" class="chat-container">
                    <!-- Приветственное сообщение -->
                    <div class="message agent-message">
                        <div class="message-avatar">
                            <span class="material-symbols-rounded">smart_toy</span>
                        </div>
                        <div class="message-content">
                            <p>Привет! Я AI Agent, использующий Claude 3.5 Haiku и Perplexity. Чем могу помочь?</p>
                        </div>
                    </div>
                </div>
                
                <div id="status" class="status" style="display: none;"></div>
                
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea id="user-input" placeholder="Введите ваш запрос..."></textarea>
                        <button id="send-button">
                            <span class="material-symbols-rounded">send</span>
                        </button>
                    </div>
                    <div class="input-footer">
                        <span class="input-info">Claude 3.5 Haiku + Perplexity</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные для DOM элементов
        let userInput;
        let chatContainer;
        let statusDiv;
        let testModeCheckbox;
        let chatHistory;
        let currentChatId = null;
        
        // Инициализация после загрузки DOM
        document.addEventListener('DOMContentLoaded', function() {
            userInput = document.getElementById('user-input');
            chatContainer = document.getElementById('chat-container');
            statusDiv = document.getElementById('status');
            testModeCheckbox = document.getElementById('test-mode-checkbox');
            
            // Настройка обработчиков событий
            document.getElementById('send-button').addEventListener('click', sendQuery);
            document.getElementById('clear-chat').addEventListener('click', clearChat);
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('new-chat').addEventListener('click', startNewChat);
            
            // Загружаем историю чатов
            chatHistory = document.getElementById('chat-history');
            loadChatHistory();
            
            // Настройка переключателя тестового режима
            if (testModeCheckbox) {
                // Проверяем, включен ли тестовый режим на сервере при загрузке страницы
                checkTestModeStatus();
                
                testModeCheckbox.addEventListener('change', function() {
                    toggleTestMode(this.checked);
                });
            }
            
            // Обработка нажатия Enter в поле ввода
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendQuery();
                }
            });
        });
        
        // Проверка статуса тестового режима на сервере
        async function checkTestModeStatus() {
            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        query: 'status',
                        test_mode: false
                    })
                });
                
                const data = await response.json();
                if (data.test_mode !== undefined) {
                    testModeCheckbox.checked = data.test_mode;
                    
                    // Если тестовый режим включен, показываем сообщение
                    if (data.test_mode) {
                        const notificationDiv = document.createElement('div');
                        notificationDiv.className = 'notification';
                        notificationDiv.textContent = 'Приложение запущено в тестовом режиме из-за отсутствия API ключей';
                        document.body.appendChild(notificationDiv);
                        
                        setTimeout(() => {
                            notificationDiv.style.opacity = '0';
                            setTimeout(() => {
                                document.body.removeChild(notificationDiv);
                            }, 500);
                        }, 5000);
                    }
                }
            } catch (error) {
                console.error('Ошибка при получении статуса тестового режима:', error);
            }
        }
        
        // Загрузка истории чатов
        async function loadChatHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Ошибка при загрузке истории:', data.error);
                    chatHistory.innerHTML = `<div class="chat-history-empty">Ошибка загрузки истории</div>`;
                    return;
                }
                
                if (!data.history || data.history.length === 0) {
                    chatHistory.innerHTML = `<div class="chat-history-empty">История чатов пуста</div>`;
                    return;
                }
                
                renderChatHistory(data.history);
            } catch (error) {
                console.error('Ошибка при загрузке истории чатов:', error);
                chatHistory.innerHTML = `<div class="chat-history-empty">Не удалось загрузить историю</div>`;
            }
        }
        
        // Отображение истории чатов
        function renderChatHistory(history) {
            chatHistory.innerHTML = '';
            
            history.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-history-item';
                if (currentChatId === chat.id) {
                    chatItem.classList.add('active');
                }
                
                // Форматируем дату и время
                const timestamp = new Date(chat.timestamp);
                const formattedDate = timestamp.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const formattedTime = timestamp.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Получаем первые 30 символов запроса для превью
                const queryPreview = chat.user_input.length > 30 
                    ? chat.user_input.substring(0, 30) + '...' 
                    : chat.user_input;
                
                chatItem.innerHTML = `
                    <div class="chat-history-item-content">
                        <div class="chat-history-item-title">${queryPreview}</div>
                        <div class="chat-history-item-time">${formattedDate}, ${formattedTime}</div>
                    </div>
                    <button class="chat-history-item-delete" data-id="${chat.id}" title="Удалить чат">
                        <span class="material-symbols-rounded">delete</span>
                    </button>
                `;
                
                // Добавляем обработчик клика для загрузки чата
                chatItem.addEventListener('click', (e) => {
                    // Игнорируем клик по кнопке удаления
                    if (e.target.closest('.chat-history-item-delete')) {
                        return;
                    }
                    loadChat(chat.id);
                });
                
                // Добавляем обработчик для кнопки удаления
                const deleteButton = chatItem.querySelector('.chat-history-item-delete');
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Предотвращаем всплытие события
                    deleteChat(chat.id);
                });
                
                chatHistory.appendChild(chatItem);
            });
        }
        
        // Загрузка конкретного чата
        async function loadChat(chatId) {
            try {
                showLoading();
                
                const response = await fetch(`/api/history/${chatId}`);
                const data = await response.json();
                
                if (data.error) {
                    showError(`Ошибка загрузки чата: ${data.error}`);
                    return;
                }
                
                if (!data.chat) {
                    showError('Чат не найден');
                    return;
                }
                
                // Очищаем текущий чат
                chatContainer.innerHTML = '';
                
                // Устанавливаем текущий ID чата
                currentChatId = chatId;
                
                // Добавляем сообщения
                addMessage(data.chat.user_input, true);
                addMessage(data.chat.response, false);
                
                // Добавляем индикаторы, если нужно
                if (data.chat.search_performed === 1) {
                    addSearchIndicator();
                }
                
                if (data.chat.test_mode === 1) {
                    const testModeIndicator = document.createElement('div');
                    testModeIndicator.className = 'test-mode-indicator';
                    testModeIndicator.innerHTML = `
                        <span class="material-symbols-rounded" style="font-size: 14px;">science</span>
                        <span>Ответ сгенерирован в тестовом режиме без использования API</span>
                    `;
                    chatContainer.appendChild(testModeIndicator);
                }
                
                // Обновляем активный элемент в истории
                const historyItems = chatHistory.querySelectorAll('.chat-history-item');
                historyItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector(`[data-id="${chatId}"]`)) {
                        item.classList.add('active');
                    }
                });
                
                clearStatus();
            } catch (error) {
                console.error('Ошибка при загрузке чата:', error);
                showError(`Произошла ошибка при загрузке чата: ${error.message}`);
            }
        }
        
        // Удаление чата
        async function deleteChat(chatId) {
            if (!confirm('Вы уверены, что хотите удалить этот чат?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/history/${chatId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error('Ошибка при удалении чата:', data.error);
                    return;
                }
                
                // Если удален текущий чат, начинаем новый
                if (currentChatId === chatId) {
                    startNewChat();
                }
                
                // Перезагружаем историю
                loadChatHistory();
                
                // Показываем уведомление
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification';
                notificationDiv.textContent = 'Чат успешно удален';
                document.body.appendChild(notificationDiv);
                
                setTimeout(() => {
                    notificationDiv.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(notificationDiv);
                    }, 500);
                }, 3000);
                
            } catch (error) {
                console.error('Ошибка при удалении чата:', error);
            }
        }
        
        // Начало нового чата
        function startNewChat() {
            currentChatId = null;
            clearChat();
            
            // Обновляем активный элемент в истории
            const historyItems = chatHistory.querySelectorAll('.chat-history-item');
            historyItems.forEach(item => {
                item.classList.remove('active');
            });
        }
                
        // Переключение тестового режима
        async function toggleTestMode(enabled) {
            try {
                const response = await fetch('/api/test_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                
                const data = await response.json();
                console.log('Тестовый режим:', data.message);
                
                // Показываем уведомление о смене режима
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification';
                notificationDiv.textContent = data.message;
                document.body.appendChild(notificationDiv);
                
                setTimeout(() => {
                    notificationDiv.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(notificationDiv);
                    }, 500);
                }, 3000);
                
            } catch (error) {
                console.error('Ошибка при переключении тестового режима:', error);
            }
        }
        
        // Форматирование текста с Markdown-подобными элементами
        function formatText(text) {
            text = text.replace(/\n/g, '<br>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');
            text = text.replace(/`(.*?)`/g, '<code>$1</code>');
            return text;
        }
        
        // Добавление сообщения в чат
        function addMessage(text, isUser) {
            if (!chatContainer) chatContainer = document.getElementById('chat-container');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message agent-message';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isUser) {
                avatarDiv.innerHTML = '<span class="material-symbols-rounded">person</span>';
                contentDiv.textContent = text;
            } else {
                avatarDiv.innerHTML = '<span class="material-symbols-rounded">smart_toy</span>';
                contentDiv.innerHTML = `<p>${formatText(text)}</p>`;
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            chatContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 100);
        }
        
        // Индикаторы статуса
        function showLoading() {
            if (!statusDiv) statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Обрабатываю ваш запрос...</p>
                </div>
            `;
        }
        
        function clearStatus() {
            if (!statusDiv) statusDiv = document.getElementById('status');
            statusDiv.style.display = 'none';
            statusDiv.innerHTML = '';
        }
        
        function showError(message) {
            if (!statusDiv) statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <div class="error">
                    <span class="material-symbols-rounded">error</span>
                    <p>${message}</p>
                </div>
            `;
        }
        
        function addSearchIndicator() {
            if (!chatContainer) chatContainer = document.getElementById('chat-container');
            
            const searchIndicator = document.createElement('div');
            searchIndicator.className = 'search-indicator';
            searchIndicator.innerHTML = `
                <span class="material-symbols-rounded" style="font-size: 14px;">search</span>
                <span>Для ответа использовалась информация из поиска</span>
            `;
            chatContainer.appendChild(searchIndicator);
        }
        
        // Очистка чата
        function clearChat() {
            if (!chatContainer) chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '';
            
            // Добавляем приветственное сообщение
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'message agent-message';
            welcomeDiv.innerHTML = `
                <div class="message-avatar">
                    <span class="material-symbols-rounded">smart_toy</span>
                </div>
                <div class="message-content">
                    <p>Привет! Я AI Agent, использующий Claude 3.5 Haiku и Perplexity. Чем могу помочь?</p>
                </div>
            `;
            chatContainer.appendChild(welcomeDiv);
        }
        
        // Переключение темы (светлая/темная)
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            
            const themeButton = document.getElementById('theme-toggle');
            if (themeButton) {
                const icon = themeButton.querySelector('.material-symbols-rounded');
                if (document.body.classList.contains('dark-theme')) {
                    icon.textContent = 'light_mode';
                    localStorage.setItem('theme', 'dark');
                } else {
                    icon.textContent = 'dark_mode';
                    localStorage.setItem('theme', 'light');
                }
            }
        }
        
        // Основная функция отправки запроса
        async function sendQuery() {
            if (!userInput) userInput = document.getElementById('user-input');
            if (!chatContainer) chatContainer = document.getElementById('chat-container');
            
            const query = userInput.value.trim();
            if (!query) {
                return;
            }
            
            // Если открыт старый чат, то при отправке нового запроса создаем новый чат
            if (currentChatId) {
                startNewChat();
            }
            
            addMessage(query, true);
            userInput.value = '';
            showLoading();
            
            try {
                console.log('Отправка запроса к API...');
                // Получаем состояние переключателя тестового режима
                const testModeCheckbox = document.getElementById('test-mode-checkbox');
                const testMode = testModeCheckbox ? testModeCheckbox.checked : false;
                
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        query,
                        test_mode: testMode  // Передаем параметр тестового режима
                    })
                });
                
                console.log('Ответ получен:', response);
                const data = await response.json();
                
                if (data.error) {
                    showError(`Ошибка: ${data.error}`);
                    return;
                }
                
                // Обновляем текущий ID чата
                currentChatId = data.id;
                
                addMessage(data.response, false);
                
                if (data.search_performed) {
                    addSearchIndicator();
                }
                
                // Если ответ получен в тестовом режиме, показываем индикатор
                if (data.test_mode) {
                    const testModeIndicator = document.createElement('div');
                    testModeIndicator.className = 'test-mode-indicator';
                    testModeIndicator.innerHTML = `
                        <span class="material-symbols-rounded" style="font-size: 14px;">science</span>
                        <span>Ответ сгенерирован в тестовом режиме без использования API</span>
                    `;
                    chatContainer.appendChild(testModeIndicator);
                }
                
                // После получения ответа обновляем историю чатов
                loadChatHistory();
                
                clearStatus();
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Произошла ошибка при обработке запроса: ${error.message}`);
            }
        }
        
        // Проверяем сохраненную тему при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                const themeButton = document.getElementById('theme-toggle');
                if (themeButton) {
                    const icon = themeButton.querySelector('.material-symbols-rounded');
                    if (icon) {
                        icon.textContent = 'light_mode';
                    }
                }
            }
        });
    </script>
</body>
</html>
        function formatText(text) {
            text = text.replace(/
/g, '<br>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');
            text = text.replace(/`(.*?)`/g, '<code>$1</code>');
            return text;
        }
        
        // Добавление сообщения в чат
        function addMessage(text, isUser) {
            if (!chatContainer) chatContainer = document.getElementById('chat-container');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message agent-message';
            
            if (!isUser) {
                messageDiv.innerHTML = formatText(text);
            } else {
                messageDiv.textContent = text;
            }
            
            chatContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 100);
        }
        
        // Индикаторы статуса
        function showLoading() {
            if (!statusDiv) statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Обрабатываю ваш запрос...</p>
                </div>
            `;
        }
        
        function clearStatus() {
            if (!statusDiv) statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '';
        }
        
        function showError(message) {
            if (!statusDiv) statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                <div class="error">
                    <span class="material-symbols-rounded">error</span>
                    <p>${message}</p>
                </div>
            `;
        }
        
        function addSearchIndicator() {
            if (!chatContainer) chatContainer = document.getElementById('chat-container');
            
            const searchIndicator = document.createElement('div');
            searchIndicator.className = 'search-indicator';
            searchIndicator.innerHTML = `
                <span class="material-symbols-rounded" style="font-size: 14px;">search</span>
                <span>Для ответа использовалась информация из поиска</span>
            `;
            chatContainer.appendChild(searchIndicator);
        }
        
        // Основная функция отправки запроса - глобальная для доступа из HTML
        window.sendQuery = async function() {
            alert('Функция sendQuery вызвана!');
            console.log('sendQuery вызван!', userInput, chatContainer);
            
            // Берем элемент напрямую на случай, если глобальная переменная не доступна
            const input = userInput || document.getElementById('user-input');
            if (!input) {
                alert('Ошибка: поле ввода не найдено!');
                console.error('Элемент ввода не найден!');
                return;
            }
            
            const query = input.value.trim();
            if (!query) {
                alert('Введите текст запроса');
                return;
            }
            
            alert('Отправляем запрос: ' + query);
            
            addMessage(query, true);
            input.value = '';
            showLoading();
            
            try {
                console.log('Отправка запроса к API...');
                // Получаем состояние переключателя тестового режима
                const testModeCheckbox = document.getElementById('test-mode-checkbox');
                const testMode = testModeCheckbox ? testModeCheckbox.checked : false;
                
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        query,
                        test_mode: testMode  // Передаем параметр тестового режима
                    })
                });
                
                console.log('Ответ получен:', response);
                const data = await response.json();
                
                if (data.error) {
                    showError(`Ошибка: ${data.error}`);
                    return;
                }
                
                addMessage(data.response, false);
                
                if (data.search_performed) {
                    addSearchIndicator();
                }
                
                // Если ответ получен в тестовом режиме, показываем индикатор
                if (data.test_mode) {
                    const testModeIndicator = document.createElement('div');
                    testModeIndicator.className = 'test-mode-indicator';
                    testModeIndicator.innerHTML = `
                        <span class="material-symbols-rounded" style="font-size: 14px;">science</span>
                        <span>Ответ сгенерирован в тестовом режиме без использования API</span>
                    `;
                    chatContainer.appendChild(testModeIndicator);
                }
                
                clearStatus();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Ошибка: ' + error.message);
                showError(`Произошла ошибка при обработке запроса: ${error.message}`);
            }
        };
    </script>
</body>
</html>
    